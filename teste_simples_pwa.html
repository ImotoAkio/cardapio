<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Simples PWA - Tempero e Caf√©</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="dist/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="dist/img/icons/favicon-32x32.png">
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-item { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ok { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { 
            background: #d3a74e; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #b8941f; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste Simples PWA - Tempero e Caf√©</h1>
    
    <div class="test-item">
        <h3>üìã Status dos Testes:</h3>
        <div id="test-results">Carregando...</div>
    </div>
    
    <div class="test-item">
        <h3>üîß A√ß√µes:</h3>
        <button onclick="testServiceWorker()">Testar Service Worker</button>
        <button onclick="testManifest()">Testar Manifest</button>
        <button onclick="testCache()">Testar Cache</button>
        <button onclick="activateServiceWorker()">Ativar Service Worker</button>
        <button onclick="clearLog()">Limpar Log</button>
    </div>
    
    <div class="test-item">
        <h3>üìù Log de Eventos:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logEntries = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push(`[${timestamp}] ${message}`);
            updateLog();
            console.log(message);
        }
        
        function updateLog() {
            document.getElementById('log').innerHTML = logEntries.join('<br>');
        }
        
        function clearLog() {
            logEntries = [];
            updateLog();
        }
        
        function updateTestResult(testName, status, message = '') {
            const resultsDiv = document.getElementById('test-results');
            const statusClass = status ? 'ok' : 'error';
            const statusIcon = status ? '‚úÖ' : '‚ùå';
            
            let existing = resultsDiv.innerHTML;
            const testRegex = new RegExp(`<div.*?id="${testName}".*?</div>`, 'g');
            existing = existing.replace(testRegex, '');
            
            resultsDiv.innerHTML = existing + `
                <div id="${testName}" class="${statusClass}">
                    ${statusIcon} ${testName}: ${status ? 'OK' : 'ERRO'} ${message}
                </div>
            `;
        }
        
        async function testServiceWorker() {
            log('Testando Service Worker...');
            
            if (!('serviceWorker' in navigator)) {
                updateTestResult('Service Worker Support', false, 'N√£o suportado');
                log('Service Worker n√£o √© suportado pelo navegador', 'error');
                return;
            }
            
            updateTestResult('Service Worker Support', true, 'Suportado');
            log('Service Worker √© suportado pelo navegador', 'success');
            
            try {
                log('Tentando registrar Service Worker...');
                const registration = await navigator.serviceWorker.register('dist/service-worker.js');
                log('Service Worker registrado com sucesso!', 'success');
                updateTestResult('Service Worker Registration', true, 'Registrado');
                
                // Aguardar o Service Worker ficar ativo
                if (registration.installing) {
                    log('Service Worker est√° instalando...', 'info');
                    registration.installing.addEventListener('statechange', function() {
                        if (this.state === 'activated') {
                            log('Service Worker ativado com sucesso!', 'success');
                            updateTestResult('Service Worker Active', true, 'Ativo');
                        }
                    });
                } else if (registration.waiting) {
                    log('Service Worker est√° aguardando...', 'info');
                    registration.waiting.addEventListener('statechange', function() {
                        if (this.state === 'activated') {
                            log('Service Worker ativado com sucesso!', 'success');
                            updateTestResult('Service Worker Active', true, 'Ativo');
                        }
                    });
                } else if (registration.active) {
                    log('Service Worker est√° ativo', 'success');
                    updateTestResult('Service Worker Active', true, 'Ativo');
                } else {
                    log('Service Worker n√£o est√° ativo ainda', 'warning');
                    updateTestResult('Service Worker Active', false, 'N√£o ativo');
                    
                    // Tentar ativar manualmente
                    setTimeout(async () => {
                        try {
                            const newRegistration = await navigator.serviceWorker.getRegistration();
                            if (newRegistration && newRegistration.active) {
                                log('Service Worker ativado ap√≥s timeout!', 'success');
                                updateTestResult('Service Worker Active', true, 'Ativo');
                            }
                        } catch (e) {
                            log('Erro ao verificar ativa√ß√£o: ' + e.message, 'error');
                        }
                    }, 3000);
                }
                
            } catch (error) {
                log(`Erro ao registrar Service Worker: ${error.message}`, 'error');
                updateTestResult('Service Worker Registration', false, error.message);
            }
        }
        
        async function testManifest() {
            log('Testando Manifest...');
            
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (!manifestLink) {
                updateTestResult('Manifest Link', false, 'Link n√£o encontrado');
                log('Link do manifest n√£o encontrado', 'error');
                return;
            }
            
            updateTestResult('Manifest Link', true, 'Link encontrado');
            log(`Manifest link encontrado: ${manifestLink.href}`, 'success');
            
            try {
                const response = await fetch(manifestLink.href);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const manifest = await response.json();
                log(`Manifest carregado: ${manifest.name}`, 'success');
                updateTestResult('Manifest Load', true, manifest.name);
                
                // Verificar √≠cones
                if (manifest.icons && manifest.icons.length > 0) {
                    log(`√çcones no manifest: ${manifest.icons.length}`, 'success');
                    updateTestResult('Manifest Icons', true, `${manifest.icons.length} √≠cones`);
                } else {
                    log('Nenhum √≠cone encontrado no manifest', 'warning');
                    updateTestResult('Manifest Icons', false, 'Nenhum √≠cone');
                }
                
            } catch (error) {
                log(`Erro ao carregar manifest: ${error.message}`, 'error');
                updateTestResult('Manifest Load', false, error.message);
            }
        }
        
        async function testCache() {
            log('Testando Cache API...');
            
            if (!('caches' in window)) {
                updateTestResult('Cache API Support', false, 'N√£o suportado');
                log('Cache API n√£o √© suportada', 'error');
                return;
            }
            
            updateTestResult('Cache API Support', true, 'Suportado');
            log('Cache API √© suportada', 'success');
            
            try {
                const cacheNames = await caches.keys();
                log(`Caches encontrados: ${cacheNames.length}`, 'info');
                updateTestResult('Cache Status', cacheNames.length > 0, `${cacheNames.length} caches`);
                
                if (cacheNames.length > 0) {
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        log(`Cache "${cacheName}": ${keys.length} itens`, 'info');
                    }
                }
                
            } catch (error) {
                log(`Erro ao verificar caches: ${error.message}`, 'error');
                updateTestResult('Cache Status', false, error.message);
            }
        }
        
        async function activateServiceWorker() {
            log('Tentando ativar Service Worker...');
            
            if (!('serviceWorker' in navigator)) {
                log('Service Worker n√£o √© suportado', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    log('Nenhum Service Worker registrado', 'error');
                    return;
                }
                
                if (registration.active) {
                    log('Service Worker j√° est√° ativo', 'success');
                    updateTestResult('Service Worker Active', true, 'Ativo');
                    return;
                }
                
                // For√ßar ativa√ß√£o
                if (registration.waiting) {
                    log('Ativando Service Worker em espera...', 'info');
                    registration.waiting.postMessage({ action: 'skipWaiting' });
                }
                
                // Aguardar ativa√ß√£o
                setTimeout(async () => {
                    const newRegistration = await navigator.serviceWorker.getRegistration();
                    if (newRegistration && newRegistration.active) {
                        log('Service Worker ativado com sucesso!', 'success');
                        updateTestResult('Service Worker Active', true, 'Ativo');
                        
                        // Recarregar p√°gina para aplicar mudan√ßas
                        log('Recarregando p√°gina para aplicar mudan√ßas...', 'info');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        log('Service Worker ainda n√£o est√° ativo', 'warning');
                    }
                }, 2000);
                
            } catch (error) {
                log(`Erro ao ativar Service Worker: ${error.message}`, 'error');
            }
        }
        
        // Executar testes autom√°ticos quando a p√°gina carregar
        window.addEventListener('load', function() {
            log('P√°gina carregada, iniciando testes autom√°ticos...');
            
            // Teste b√°sico de suporte
            updateTestResult('HTTPS/Localhost', 
                location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
                location.protocol + '//' + location.hostname
            );
            
            // Teste de √≠cones
            const icons = document.querySelectorAll('link[rel="icon"]');
            updateTestResult('Favicon Icons', icons.length > 0, `${icons.length} √≠cones`);
            
            // Executar testes principais ap√≥s um pequeno delay
            setTimeout(() => {
                testManifest();
                testServiceWorker();
                testCache();
            }, 1000);
        });
        
        // Listener para eventos do Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                log(`Mensagem do Service Worker: ${event.data}`, 'info');
            });
        }
    </script>
</body>
</html>
